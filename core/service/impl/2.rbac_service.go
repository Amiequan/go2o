/**
 * this file is auto generated by tto v0.3.23 !
 * if you want to modify this code,please read guide doc
 * and modify code template later.
 *
 *  please read user guide on https://github.com/ixre/tto
 *
 */

package impl

/**
 * Copyright (C) 2007-2020 56X.NET,All rights reserved.
 *
 * name : perm_dept_service.go
 * author : jarrysix (jarrysix#gmail.com)
 * date : 2020/12/02 13:02:38
 * description :
 * history :
 */

import (
	"context"
	"github.com/ixre/gof/db/orm"
	"github.com/ixre/gof/storage"
	"github.com/ixre/gof/types"
	"github.com/ixre/gof/types/typeconv"
	"go2o/core/dao"
	"go2o/core/dao/impl"
	"go2o/core/dao/model"
	"go2o/core/service/proto"
	"time"
)

var _ proto.RBACServiceServer = new(rbacServiceImpl)

// 基于角色的权限服务
type rbacServiceImpl struct {
	dao dao.IRbacDao
	s   storage.Interface
	serviceUtil
}

func NewPermDeptService(s storage.Interface, o orm.Orm) *rbacServiceImpl {
	return &rbacServiceImpl{
		s:   s,
		dao: impl.NewRbacDao(o),
	}
}

// 保存部门
func (a *rbacServiceImpl) SavePermDept(_ context.Context, r *proto.SavePermDeptRequest) (*proto.SavePermDeptResponse, error) {
	var dst *model.PermDept
	if r.Id > 0 {

		dst = a.dao.GetPermDept(r.Id)
	} else {
		dst = &model.PermDept{}
		dst.CreateTime = time.Now().Unix()
	}

	dst.Name = r.Name
	dst.Pid = r.Pid
	dst.Enabled = int16(r.Enabled)

	id, err := a.dao.SavePermDept(dst)
	ret := &proto.SavePermDeptResponse{
		Id: int64(id),
	}
	if err != nil {
		ret.ErrCode = 1
		ret.ErrMsg = err.Error()
	}
	return ret, nil
}

// 获取部门
func (a *rbacServiceImpl) GetPermDept(_ context.Context, id *proto.PermDeptId) (*proto.SPermDept, error) {
	v := a.dao.GetPermDept(id.Value)
	if v == nil {
		return nil, nil
	}
	return &proto.SPermDept{

		Id:         v.Id,
		Name:       v.Name,
		Pid:        v.Pid,
		Enabled:    int32(v.Enabled),
		CreateTime: v.CreateTime,
	}, nil
}

func (a *rbacServiceImpl) DeletePermDept(_ context.Context, id *proto.PermDeptId) (*proto.Result, error) {
	err := a.dao.DeletePermDept(id.Value)
	return a.error(err), nil
}

func (a *rbacServiceImpl) PagingPermDept(_ context.Context, r *proto.PermDeptPagingRequest) (*proto.PermDeptPagingResponse, error) {
	total, rows := a.dao.PagingQueryPermDept(int(r.Params.Begin),
		int(r.Params.End),
		r.Params.Where,
		r.Params.SortBy)
	ret := &proto.PermDeptPagingResponse{
		Total: int64(total),
		Value: make([]*proto.PagingPermDept, len(rows)),
	}
	for i, v := range rows {

		ret.Value[i] = &proto.PagingPermDept{

			Id:         int64(typeconv.MustInt(v["id"])),
			Name:       types.Stringify(v["name"]),
			Pid:        int64(typeconv.MustInt(v["pid"])),
			Enabled:    int32(typeconv.MustInt(v["enabled"])),
			CreateTime: int64(typeconv.MustInt(v["create_time"])),
		}
	}
	return ret, nil
}
