/**
 * this file is auto generated by tto v0.3.23 !
 * if you want to modify this code,please read guide doc
 * and modify code template later.
 *
 *  please read user guide on https://github.com/ixre/tto
 *
 */

package impl

/**
 * Copyright (C) 2007-2020 56X.NET,All rights reserved.
 *
 * name : perm_dept_service.go
 * author : jarrysix (jarrysix#gmail.com)
 * date : 2020/12/02 13:02:38
 * description :
 * history :
 */

import (
	"context"
	"github.com/ixre/gof/db/orm"
	"github.com/ixre/gof/storage"
	"go2o/core/dao"
	"go2o/core/dao/impl"
	"go2o/core/dao/model"
	"go2o/core/service/proto"
	"time"
)

var _ proto.RBACServiceServer = new(rbacServiceImpl)

// 基于角色的权限服务
type rbacServiceImpl struct {
	dao dao.IRbacDao
	s   storage.Interface
	serviceUtil
}

func walkDepartTree(node *proto.RbacTree, nodeList []*model.PermDept) {
	node.Children = []*proto.RbacTree{}
	for _, v := range nodeList {
		if v.Pid == node.Id {
			v := &proto.RbacTree{
				Id:       v.Id,
				Name:     v.Name,
				Pid:      v.Pid,
				Children: make([]*proto.RbacTree, 0),
			}
			node.Children = append(node.Children, v)
			walkDepartTree(v, nodeList)
		}
	}
}

// 部门树形数据
func (a *rbacServiceImpl) DepartTree(_ context.Context, empty *proto.Empty) (*proto.RbacTree, error) {
	root := &proto.RbacTree{
		Id:                   0,
		Name:                 "根节点",
		Pid:                  0,
		Children:             make([]*proto.RbacTree,0),
	}
	list := a.dao.SelectPermDept("")
	walkDepartTree(root,list)
	return root,nil
}

func NewRbacService(s storage.Interface, o orm.Orm) *rbacServiceImpl {
	return &rbacServiceImpl{
		s:   s,
		dao: impl.NewRbacDao(o),
	}
}

// 保存部门
func (a *rbacServiceImpl) SavePermDept(_ context.Context, r *proto.SavePermDeptRequest) (*proto.SavePermDeptResponse, error) {
	var dst *model.PermDept
	if r.Id > 0 {
		dst = a.dao.GetPermDept(r.Id)
	} else {
		dst = &model.PermDept{}
		dst.CreateTime = time.Now().Unix()
	}

	dst.Name = r.Name
	dst.Pid = r.Pid
	dst.Enabled = int16(r.Enabled)

	id, err := a.dao.SavePermDept(dst)
	ret := &proto.SavePermDeptResponse{
		Id: int64(id),
	}
	if err != nil {
		ret.ErrCode = 1
		ret.ErrMsg = err.Error()
	}
	return ret, nil
}

// 获取部门
func (a *rbacServiceImpl) GetPermDept(_ context.Context, id *proto.PermDeptId) (*proto.SPermDept, error) {
	v := a.dao.GetPermDept(id.Value)
	if v == nil {
		return nil, nil
	}
	return a.parsePermDept(v), nil
}

func (a *rbacServiceImpl) DeletePermDept(_ context.Context, id *proto.PermDeptId) (*proto.Result, error) {
	err := a.dao.DeletePermDept(id.Value)
	return a.error(err), nil
}

// 获取部门列表
func (a *rbacServiceImpl) QueryPermDeptList(_ context.Context, r *proto.QueryPermDeptRequest) (*proto.QueryPermDeptResponse, error) {
	arr := a.dao.SelectPermDept("1=1")
	ret := &proto.QueryPermDeptResponse{
		List: make([]*proto.SPermDept, len(arr)),
	}
	for i, v := range arr {
		ret.List[i] = a.parsePermDept(v)
	}
	return ret, nil
}

func (a *rbacServiceImpl) parsePermDept(v *model.PermDept) *proto.SPermDept {
	return &proto.SPermDept{
		Id:         v.Id,
		Name:       v.Name,
		Pid:        v.Pid,
		Enabled:    int32(v.Enabled),
		CreateTime: v.CreateTime,
	}
}
